# Project Context Document (Internal)

> **PURPOSE**: This is a living document for Claude/Cursor AI assistants. It provides project context, current status, and guidance for future sessions. **UPDATE THIS DOCUMENT** at the end of each significant work session.

---

## Project Overview

**Title**: Antibody-Antigen Binding Prediction with Multimodal Deep Learning

**Goal**: Build a multimodal transformer to predict antibody binding affinity using:
- Protein sequences (H + L chains)
- 3D structural coordinates from AlphaFold 3
- Interface contact maps

**Dataset**: 606 antibody samples with binding measurements against 7 influenza H3 variants

---

## Current Status

**Last Updated**: 2024-02-04

### Completed Milestones

1. **Data Pipeline** ✅
   - Merged antibody sequences with binding measurements
   - Cleaned and validated 606 samples
   - Mapped immunogen names to FASTA sequences

2. **AF3 Input Generation** ✅
   - Generated 70 AF3 input JSONs (top 10 binders per immunogen)
   - Fixed chain ID issue (Ag → A for uppercase requirement)
   - Structure: H chain + L chain + Antigen in each JSON

3. **Candidate Selection for Epitope Studies** ✅
   - Identified antibodies with differential binding:
     - HIGH binding to HK68 and 1JPLm414_T_G3
     - LOW/NO binding to 1JPL_WT
   - Top candidates: P40G1, P38B10, P40A10
   - Generated AF3 JSONs for these candidates with T_G3 antigen

### In Progress

4. **AF3 Structure Predictions**
   - P10A1_1JPL_WT completed (test run)
   - 3 new candidates ready: P40G1, P38B10, P40A10 with T_G3
   - Remaining: batch processing for all 70+ complexes

### Pending

5. **Feature Extraction** (src/data/)
   - Parse CIF files for 3D coordinates
   - Extract PAE matrices for confidence scores
   - Build contact maps from inter-residue distances

6. **Model Development** (src/models/)
   - Implement multimodal transformer architecture
   - Cross-attention fusion layers
   - Binding affinity regression head

---

## Key Technical Details

### AF3 Chain Ordering Issue
**IMPORTANT**: AlphaFold 3 reorders chains alphabetically in output:
- Input order: H, L, A
- Output order: A, H, L (alphabetical)

When extracting features, use token_chain_ids from confidences.json to map correctly.

### Data Locations
```
data/raw/
├── cleaned_data.csv          # 606 antibodies with sequences + binding
├── immunogens.fasta          # 6 antigen sequences

data/processed/
├── af3_inputs/               # 70+ AF3 input JSONs
├── af3_outputs/              # Predicted structures (CIF + confidence)
└── modeling_candidates.csv   # Selected candidates for epitope study
```

### Immunogen Mapping
| Column Name | Standardized | FASTA Header |
|-------------|--------------|--------------|
| 1JPLm414_C_G1 | 1JPLm414_C_G1 | 1JPL-m4i4-C-G1 |
| 1JPLm414_T_G3_PAPRE | 1JPLm414_T_G3 | 1JPL-m4i4-T-G3 |
| 1JPL_4I_Avi | 1JPL_4I | 1JPL-4i |
| 1JPL_WT_Avi | 1JPL_WT | 1JPL WT |
| A/Hong Kong/1/1968 | HK68 | HK68head_WT |
| H3/Johannesberg/94 avi bio | H3_JHB_94 | H3/Johannesburg/94_avibio |

### Top Modeling Candidates (Differential Binding)
| Sample | T_G3 | WT | HK68 | Notes |
|--------|------|-----|------|-------|
| P40G1 | 199,567 | 8.6 | 60,357 | Best overall |
| P38B10 | 28,281 | 4.3 | 2,239 | Strong T_G3/WT ratio |
| P40A10 | 29,854 | 7.3 | 1,612 | Good selectivity |

---

## Notebook Guide

| Notebook | Purpose | Status |
|----------|---------|--------|
| 01_dataset_prep.ipynb | Merge sequences + binding data | ✅ Complete |
| 02_af3_complex_input_prep.ipynb | Generate AF3 JSONs | ✅ Complete |
| 03_run_af3_prediction.ipynb | Run AF3 via Singularity | ✅ Working |
| 04_separate_chain_inputs.ipynb | Test separate H+L vs Ag folding | ✅ Created |
| 05_modeling_candidate_selection.ipynb | Find differential binders | ✅ Complete |

---

## Instructions for Future Sessions

### Before Starting Work
1. Read this document to understand current state
2. Check `git status` for uncommitted changes
3. Review the notebook that's most relevant to the task

### After Completing Work
**UPDATE THIS DOCUMENT** with:
- New completed milestones
- Changes to in-progress items
- Any new technical details discovered
- Updated file locations if changed

### Common Tasks

**Add new AF3 inputs**:
- Use notebook 02 or follow JSON format in `af3_inputs/`
- Chain IDs must be uppercase single letters (H, L, A)

**Run AF3 prediction**:
- See notebook 03 for Singularity command
- Output goes to `af3_outputs/{job_name_lowercase}/`

**Extract features from AF3 output**:
- CIF file has 3D coordinates (chains reordered alphabetically!)
- confidences.json has PAE matrix and pLDDT scores
- Use token_chain_ids to map residues correctly

---

## Git Workflow

**Branch**: main

**Commit style**: lowercase, descriptive
- `add feature X for Y`
- `fix issue with Z`
- `update notebook for W`

**IMPORTANT: NO co-authorship lines in commits.** Do not add "Co-Authored-By" to commit messages.

**Files to commit**:
- All notebooks
- src/ code
- README.md
- This context file

**Files NOT to commit** (in .gitignore):
- data/ (too large)
- __pycache__/
- .ipynb_checkpoints/

---

*End of context document*
